rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ═══════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ═══════════════════════════════════════════════════════
    
    // Prüft ob Nutzer authentifiziert ist
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Prüft ob Nutzer der Eigentümer ist
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Prüft ob Daten valide sind (nicht leer)
    function isValidData() {
      return request.resource.data.keys().hasAny(['title', 'name', 'content']);
    }
    
    // Prüft ob Zeitstempel gültig ist
    function isValidTimestamp() {
      return request.resource.data.created_at is timestamp;
    }
    
    // ═══════════════════════════════════════════════════════
    // EVENTS COLLECTION
    // Haupt-Datenbank für historische Events
    // ═══════════════════════════════════════════════════════
    match /events/{eventId} {
      // LESEN: Jeder kann Events lesen (auch ohne Auth)
      allow read: if true;
      
      // ERSTELLEN: Nur authentifizierte Nutzer
      allow create: if isSignedIn() 
                    && isValidData()
                    && request.resource.data.keys().hasAll([
                      'title', 'date', 'description', 'category'
                    ]);
      
      // AKTUALISIEREN: Nur Admin oder Eigentümer
      allow update: if isSignedIn() 
                    && (
                      isOwner(resource.data.created_by)
                      || request.auth.token.admin == true
                    );
      
      // LÖSCHEN: Nur Admin
      allow delete: if isSignedIn() 
                    && request.auth.token.admin == true;
    }
    
    // ═══════════════════════════════════════════════════════
    // TELEGRAM MEDIA COLLECTION
    // Telegram Kanal Medien-Bibliothek
    // ═══════════════════════════════════════════════════════
    match /telegram_media/{mediaId} {
      // LESEN: Jeder kann Medien lesen
      allow read: if true;
      
      // ERSTELLEN: Nur authentifizierte Nutzer
      allow create: if isSignedIn()
                    && request.resource.data.keys().hasAll([
                      'title', 'category', 'media_type', 'timestamp'
                    ]);
      
      // AKTUALISIEREN: Nur Admin
      allow update: if isSignedIn() 
                    && request.auth.token.admin == true;
      
      // LÖSCHEN: Nur Admin
      allow delete: if isSignedIn() 
                    && request.auth.token.admin == true;
    }
    
    // ═══════════════════════════════════════════════════════
    // CATEGORIES COLLECTION
    // Kategorien-Verwaltung
    // ═══════════════════════════════════════════════════════
    match /categories/{categoryId} {
      // LESEN: Jeder kann Kategorien lesen
      allow read: if true;
      
      // ERSTELLEN: Nur Admin
      allow create: if isSignedIn() 
                    && request.auth.token.admin == true
                    && request.resource.data.keys().hasAll([
                      'name', 'color', 'icon'
                    ]);
      
      // AKTUALISIEREN: Nur Admin (für event_count Updates)
      allow update: if isSignedIn() 
                    && request.auth.token.admin == true;
      
      // LÖSCHEN: Nur Admin
      allow delete: if isSignedIn() 
                    && request.auth.token.admin == true;
    }
    
    // ═══════════════════════════════════════════════════════
    // USER PREFERENCES (Optional für zukünftige Features)
    // ═══════════════════════════════════════════════════════
    match /users/{userId} {
      // Nur eigene Daten lesen/schreiben
      allow read, write: if isOwner(userId);
    }
    
    // ═══════════════════════════════════════════════════════
    // FAVORITES (Optional für zukünftige Features)
    // ═══════════════════════════════════════════════════════
    match /users/{userId}/favorites/{favoriteId} {
      // Nur eigene Favoriten lesen/schreiben
      allow read, write: if isOwner(userId);
    }
    
    // ═══════════════════════════════════════════════════════
    // DEFAULT DENY (Alle anderen Pfade)
    // ═══════════════════════════════════════════════════════
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
